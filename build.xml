<?xml version="1.0"?>
<project name="Alloy" basedir="." default="release">
	<property name="project.dir" value="."/>

	<property environment="env" />

	<property file="${project.dir}/build.${user.name}.properties" />
	<property file="${project.dir}/build.${env.COMPUTERNAME}.properties" />
	<property file="${project.dir}/build.${env.HOST}.properties" />
	<property file="${project.dir}/build.${env.HOSTNAME}.properties" />
	<property file="${project.dir}/build.properties" />

	<import file="resources/builder/bootstrap.xml"/>

	<target name="all" depends="build-aui, init-yui"/>

	<target name="build-aui" depends="build-components, build-modules, build-skins, clean"/>

	<target name="build-gallery" depends="build-gallery-templates, build-gallery-components, build-gallery-skins, build-gallery-modules, generate-skin-src, clean-module-src, clean-gallery-templates, export-gallery" />

	<target name="build-gallery-templates">
		<echo>Backing up templates</echo>

		<copy todir="${project.dir}/resources/builder/_new_templates">
			<fileset dir="${project.dir}/resources/builder/templates"/>
		</copy>

		<replace file="${project.dir}/resources/builder/_new_templates/moduledefaults.txt">
			<replacefilter token="classNamePrefix: 'aui'," value="" />
		</replace>

		<move todir="${project.dir}/resources/builder/_old_templates">
			<fileset dir="${project.dir}/resources/builder/templates"/>
		</move>

		<move todir="${project.dir}/resources/builder/templates">
			<fileset dir="${project.dir}/resources/builder/_new_templates"/>
		</move>
	</target>

	<target name="clean-gallery-templates">
		<echo>Cleaning up templates</echo>

		<move todir="${project.dir}/resources/builder/templates" overwrite="true">
			<fileset dir="${project.dir}/resources/builder/_old_templates"/>
		</move>
	</target>

	<target name="build-gallery-components" depends="remove-whitespace">
		<subant target="all">
			<fileset dir="${project.dir}/src/">
				<exclude name="build.xml" />
				<exclude name="${build.aui.prefix}aui-skin-*/build.xml" />
				<include name="**/build.xml" />
			</fileset>
		</subant>
	</target>

	<target name="build-gallery-modules">
		<create-module-list prependdefaults="false"/>
	</target>

	<target name="build-gallery-skins">
		<antcall target="build-skins-core" />
	</target>

	<target name="build-components" depends="remove-whitespace">
		<subant target="all">
			<fileset
				dir="${project.dir}/src/"
				excludes="build.xml, aui-skin-*/build.xml, aui-skin-*/**/build.xml"
				includes="**/build.xml"
			/>
		</subant>
	</target>

	<target name="build-modules">
		<subant target="all">
			<fileset
				dir="${project.dir}/src/aui-base/"
				includes="**/build.xml"
			/>
		</subant>

		<create-module-list/>
	</target>

	<target name="export-gallery">
		<if>
			<isset property="github.gallery.directory" />
			<then>
				<copy todir="${github.gallery.directory}/src" overwrite="true">
					<fileset dir="${project.dir}/src">
						<exclude name="**/build_*"/>
						<exclude name="**/_diffs/**"/>
						<exclude name="**/build.all-css.*"/>
					</fileset>
				</copy>
			</then>
		</if>
	</target>

	<target name="clean-module-src">
		<delete includeemptydirs="true">
			<fileset dir="${project.dir}/src/" defaultexcludes="false">
				<include name="**/*build_tmp*/**" />
				<include name="**/*build_rollup_tmp*/**" />
			</fileset>
		</delete>
	</target>

	<target name="create-module-list">
		<create-module-list/>
	</target>

	<target name="build-skins-core">
		<antcall target="generate-skin-src" />

		<delete dir="${project.dir}/src/${build.aui.prefix}aui-skin-*/build_tmp" />

		<subant target="local">
			<property name="clean.skip" value="true"/>

			<fileset dir="${project.dir}/src">
				<include name="${build.aui.prefix}aui-skin-*/build*.xml"/>
			</fileset>
		</subant>

		<!-- Deploy to the build directory -->

		<copy todir="${project.dir}/build" overwrite="true">
			<fileset dir="${project.dir}/src">
				<include name="${build.aui.prefix}aui-skin-*/css/**"/>
				<include name="${build.aui.prefix}aui-skin-*/images/**"/>
				<include name="${build.aui.prefix}aui-skin-*/build_tmp/**"/>
			</fileset>
		</copy>

		<!-- Move the built files into the CSS directory -->

		<for param="dir">
			<path>
				<dirset
					dir="${project.dir}/build"
					includes="${build.aui.prefix}aui-skin-*"
				/>
			</path>
			<sequential>
				<copy todir="@{dir}/css" overwrite="true">
					<fileset dir="@{dir}/build_tmp" includes="*"/>
				</copy>
			</sequential>
		</for>

		<delete includeemptydirs="true">
			<fileset dir="${project.dir}/build">
				<include name="${build.aui.prefix}aui-skin-*/build_tmp/**"/>
				<include name="${build.aui.prefix}aui-skin-*/build_tmp"/>
			</fileset>
		</delete>
	</target>

	<target name="build-skins">
		<antcall target="build-skins-core"/>

		<create-module-list/>
	</target>

	<target name="clean-skin-src">
		<for param="dir">
			<path>
				<dirset
					dir="${project.dir}/src"
					includes="${build.aui.prefix}aui-skin-*"
					excludes="${build.aui.prefix}aui-skin-base"
				/>
			</path>
			<sequential>
				<delete includeemptydirs="true">
					<fileset dir="@{dir}">
						<include name="**/*"/>
						<exclude name="_diffs/**"/>
					</fileset>
				</delete>
			</sequential>
		</for>
	</target>

	<target name="generate-skin-src">
		<for param="dir">
			<path>
				<dirset
					dir="${project.dir}/src"
					includes="${build.aui.prefix}aui-skin-*"
					excludes="${build.aui.prefix}aui-skin-base"
				/>
			</path>
			<sequential>
				<basename property="skin.name" file="@{dir}"/>

				<!-- Copy over everything from our base theme -->

				<copy todir="@{dir}" overwrite="true">
					<fileset dir="${project.dir}/src/${build.aui.prefix}aui-skin-base">
						<include name="**"/>
						<exclude name="build_tmp"/>
						<exclude name="build_tmp/**"/>
					</fileset>
				</copy>

				<!-- Create the build.all-css files -->

				<copy todir="@{dir}" overwrite="true">
					<fileset dir="${project.dir}/src/${build.aui.prefix}aui-skin-base">
						<include name="build.*"/>
					</fileset>
					<mapper type="regexp" from="build\.(.*)" to="build.all-css.\1"/>
				</copy>

				<!-- Guarantee load order to be after the base -->

				<replace file="@{dir}/build.properties">
					<replacefilter token="${build.aui.prefix}aui-skin-base" value="${skin.name}" />
					<replacefilter token="#component.requires=" value="component.requires=${build.aui.prefix}aui-skin-base" />
				</replace>

				<!-- Remove all component.cssfiles *except* the custom.css one -->

				<replaceregexp match="component\.cssfiles=(.*)$" replace="component.cssfiles=custom.css" flags="g" byline="true">
					<fileset dir="@{dir}/" includes="build.properties"/>
				</replaceregexp>

				<!-- Process the build.all-css files -->

				<replace file="@{dir}/build.all-css.properties">
					<replacefilter token="${build.aui.prefix}aui-skin-base" value="${skin.name}-all" />
					<replacefilter token="global.build.component.assets=$${srcdir}/build/$${component}" value="global.build.component.assets=$${srcdir}/build/${skin.name}" />
					<replacefilter token="${skin.name}-all/" value="${skin.name}/" />
				</replace>

				<replace file="@{dir}/build.all-css.xml">
					<replacefilter token="build.properties" value="build.all-css.properties" />
				</replace>

				<!-- Copy over the contents of _diffs -->

				<if>
					<available file="@{dir}/_diffs" />
					<then>
						<copy todir="@{dir}" overwrite="true">
							<fileset
								dir="@{dir}/_diffs"
							/>
						</copy>
					</then>
				</if>

			</sequential>
		</for>
	</target>

	<target name="build-yui">
		<subant target="all">
			<fileset
				dir="${project.dir}/lib/yui3/src"
				excludes="build.xml"
				includes="**/build.xml"
			/>
		</subant>

		<antcall target="patch-yui" />

		<antcall target="export-yui" />

		<antcall target="copyright-yui" />
	</target>

	<target name="clean">
		<antcall target="clean-module-src"/>

		<antcall target="clean-skin-src"/>
	</target>

	<target name="clean-release">
		<delete dir="${release.temp.dir}" />
		<delete file="${project.dir}/${release.file.name}" />
	</target>

	<target name="init-yui">
		<echo>Initializing YUI Library.</echo>

		<antcall target="generate-yui" />

		<antcall target="patch-yui" />

		<antcall target="export-yui" />

		<antcall target="copyright-yui" />
	</target>

	<target name="generate-yui">
		<delete dir="${yui3.dir}" />
		<unzip src="${project.dir}/lib/${yui3.file}" dest="${project.dir}/lib/" />
	</target>

	<target name="export-yui">
		<echo>Copying files from [${project.dir}/lib/yui3/build] to [${project.dir}/build].</echo>

		<copy todir="${project.dir}/build" overwrite="true">
			<fileset dir="${project.dir}/lib/yui3/build">
				<include name="**/*"/>
			</fileset>
		</copy>
	</target>

	<target name="copyright-yui">
		<echo>Adding YUI Copyright information</echo>

		<copy todir="${project.dir}/build" includeEmptyDirs="false" overwrite="true" encoding="UTF-8">
			<fileset dir="${project.dir}/lib/yui3/build">
				<or>
					<filename name="**/*.css"/>
					<filename name="**/*.js"/>
				</or>
			</fileset>
			<filterchain>
				<concatfilter prepend="${project.dir}/resources/builder/templates/yui-copyright.txt"/>
				<replacetokens>
					<token key="VERSION" value="${yui3.version}"/>
					<token key="BUILD" value="${yui3.build.version}"/>
				</replacetokens>
			</filterchain>
		</copy>
	</target>

	<target name="patch-yui">
		<echo>Adding patches to [${project.dir}/lib/yui3/build]</echo>

		<copy todir="${project.dir}/lib/yui3" overwrite="true">
			<fileset dir="${project.dir}/lib/patches/yui3" includes="**/*.*" />
		</copy>

		<!-- Patch for widget-locale -->
		<replace file="${project.dir}/lib/yui3/src/widget/js/WidgetLocale.js">
			<replacefilter token="Y.mix(Widget.prototype, {" value="Widget.ATTRS.strings.lazyAdd = false; Y.mix(Widget.prototype, {" />
		</replace>

		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/widget"
				includes="build.xml"
			/>
		</subant>
		<!-- /End Patch -->

		<!-- Patch for dd -->
		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/dd"
				includes="build.xml"
			/>
		</subant>

		<!-- Patch for event -->
		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/event"
				includes="build.xml"
			/>
		</subant>

		<!-- Patch for event-custom -->
		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/event-custom"
				includes="build.xml"
			/>
		</subant>

		<!-- Patch for loader -->
		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/loader"
				includes="build.xml"
			/>
		</subant>

		<!-- Patch for simpleyui -->
		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/simpleyui"
				includes="build.xml"
			/>
		</subant>

		<!-- Patch for yui -->
		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/yui"
				includes="build.xml"
			/>
		</subant>

		<!-- /End Patch -->

		<!-- Patch for AUI-153 -->
		<replace file="${project.dir}/lib/yui3/src/dom/js/dom.js">
			<replacetoken><![CDATA[if (m && custom[m[1]]) {
                if (typeof custom[m[1]] === 'function') {
                    create = custom[m[1]];
                } else {
                    tag = custom[m[1]];
                }
            }]]></replacetoken>
			  <replacevalue><![CDATA[var creator = m && custom[m[1].toLowerCase()];

	            if (creator) {
	                if (typeof creator === 'function') {
	                    create = creator;
	                } else {
	                    tag = creator;
	                }
	            }]]></replacevalue>
		</replace>
		<!-- /End Patch for AUI-153 -->

		<!-- Patch for AUI-313 -->
		<replace file="${project.dir}/lib/yui3/src/dom/js/dom.js">
			<replacetoken><![CDATA[re_tag = /<([a-z]+)/i;]]></replacetoken>
			  <replacevalue><![CDATA[re_tag = /<([a-z]+)/i,

		    createFromDIV = function(html, tag) {
		        var div = Y.config.doc.createElement('div'),
		            ret = true;

		        div.innerHTML = html;
		        if (!div.firstChild || div.firstChild.tagName !== tag) {
		            ret = false;
		        }

		        return ret;
		    };]]></replacevalue>
		</replace>

		<replace file="${project.dir}/lib/yui3/src/dom/js/dom.js">
			<replacetoken><![CDATA[if (Y.UA.gecko || Y.UA.ie) {]]></replacetoken>
			<replacevalue><![CDATA[if (!createFromDIV('<tr/>', 'TR')) {]]></replacevalue>
		</replace>

		<replace file="${project.dir}/lib/yui3/src/dom/js/dom.js">
			<replacetoken><![CDATA[tbody: function(html, doc) {
			                return create(TABLE_OPEN + html + TABLE_CLOSE, doc);
			            }]]></replacetoken>
			<replacevalue><![CDATA[col: function(html, doc) {
	                return create('<colgroup>' + html + '</colgroup>', doc);
	            },
	            tbody: 'table']]></replacevalue>
		</replace>

		<replace file="${project.dir}/lib/yui3/src/dom/js/dom.js">
			<replacetoken><![CDATA[col: creators.tbody,]]></replacetoken>
			<replacevalue><![CDATA[]]></replacevalue>
		</replace>

		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/dom"
				includes="build.xml"
			/>
		</subant>
		<!-- /End Patch for AUI-313 -->

		<!-- Patch for AUI-401-->
		<replace file="${project.dir}/lib/yui3/src/dom/js/dom-style-ie.js">
			<replacetoken><![CDATA[if (Y.UA.ie && Y.UA.ie < 9) {]]></replacetoken>
			<replacevalue><![CDATA[if (Y.UA.ie && (Y.UA.ie < 9 || Y.config.doc.documentMode < 9)) {]]></replacevalue>
		</replace>

		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/dom"
				includes="build.style-ie.xml"
			/>
		</subant>
		<!-- /End Patch for AUI-401-->

		<!-- Patch for AUI-284 -->
		<replace file="${project.dir}/lib/yui3/src/io/js/io-upload-iframe.js">
			<replacetoken><![CDATA[if (a.hasOwnProperty(a, p)) {]]></replacetoken>
			  <replacevalue><![CDATA[if (a.hasOwnProperty(p)) {]]></replacevalue>
		</replace>
		<replace file="${project.dir}/lib/yui3/src/io/js/io-upload-iframe.js">
			<replacetoken><![CDATA[f.setAttribute(p, f[p]);]]></replacetoken>
			  <replacevalue><![CDATA[f.setAttribute(p, a[p]);]]></replacevalue>
		</replace>
		<!-- /End Patch for AUI-284-->

		<!-- Patch for AUI-285 -->
		<replace file="${project.dir}/lib/yui3/src/io/js/io-base.js">
			<replacetoken><![CDATA[function _destroy(o) {
        // IE, when using XMLHttpRequest as an ActiveX Object, will throw
        // a "Type Mismatch" error if the event handler is set to "null".
        if (w && w.XMLHttpRequest) {
            if (o.c) {
                o.c.onreadystatechange = null;
            }
        }

        o.c = null;
        o = null;
    }]]></replacetoken>
			  <replacevalue><![CDATA[function _destroy(o) {
        if (w) {
            if (o.c && w.XMLHttpRequest) {
                o.c.onreadystatechange = null;
            }
			else if (Y.UA.ie === 6 && !o.t) {
				// IE, when using XMLHttpRequest as an ActiveX Object, will throw
				// a "Type Mismatch" error if the event handler is set to "null".
				o.c.abort();
			}
        }

        o.c = null;
        o = null;
    }]]></replacevalue>
		</replace>
		<replace file="${project.dir}/lib/yui3/src/io/js/io-upload-iframe.js">
			<replacetoken><![CDATA[f.setAttribute(p, f[p]);]]></replacetoken>
			  <replacevalue><![CDATA[f.setAttribute(p, a[p]);]]></replacevalue>
		</replace>
		<!-- /End Patch for AUI-285-->

		<!-- Patch for AUI-284 & AUI-285-->
		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/io"
				includes="build.xml"
			/>
		</subant>
		<!-- /End Patch for AUI-284 & AUI-285-->

		<!-- Patch for AUI-297 -->
		<replace file="${project.dir}/lib/yui3/src/event/js/event-ready-base-ie.js">
			<replacetoken><![CDATA[GLOBAL_ENV.Env.]]></replacetoken>
			<replacevalue><![CDATA[GLOBAL_ENV.]]></replacevalue>
		</replace>

		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/event"
				includes="build-base-ie.xml"
			/>
		</subant>
		<!-- /End Patch for AUI-297 -->

		<!-- Patch for AUI-363 -->
		<replace file="${project.dir}/lib/yui3/src/dd/js/delegate.js">
			<replacetoken><![CDATA[this.dd.on('dragNodeChange', Y.bind(this._onNodeChange, this));]]></replacetoken>
			  <replacevalue><![CDATA[this.dd.on('dragNodeChange', Y.bind(this._onNodeChange, this));
            this.dd.after('drag:mouseup', function() {
                this._unprep();
            });]]></replacevalue>
		</replace>

		<replace file="${project.dir}/lib/yui3/src/dd/js/drag.js">
			<replacetoken><![CDATA[_handleMouseUp: function(ev) {]]></replacetoken>
			  <replacevalue><![CDATA[_handleMouseUp: function(ev) {
            this.fire('drag:mouseup');]]></replacevalue>
		</replace>

		<replace file="${project.dir}/lib/yui3/src/dd/js/drag.js">
			<replacetoken><![CDATA[node.addClass(DDM.CSS_PREFIX + '-draggable');

            node.addClass(DDM.CSS_PREFIX + '-draggable');]]></replacetoken>
			  <replacevalue><![CDATA[node.addClass(DDM.CSS_PREFIX + '-draggable');]]></replacevalue>
		</replace>

		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/dd"
				includes="build.xml"
			/>
		</subant>
		<!-- /End Patch for AUI-363 -->

		<!-- Patch for AUI-445 -->
		<replace file="${project.dir}/lib/yui3/src/dataschema/js/dataschema-xml.js">
			<replacetoken><![CDATA[context = context.childNodes[subloc];]]></replacetoken>
			<replacevalue><![CDATA[context = context.children[subloc];]]></replacevalue>
		</replace>

		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/dataschema"
				includes="build.xml"
			/>
		</subant>

		<replace file="${project.dir}/lib/yui3/src/datatype/js/datatype-xml-parse.js">
			<replacetoken><![CDATA[try {
                if(!LANG.isUndefined(DOMParser)) {
                    xmlDoc = new DOMParser().parseFromString(data, "text/xml");
                }
            }
            catch(e) {
                try {
                    if(!LANG.isUndefined(ActiveXObject)) {
                            xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
                            xmlDoc.async = false;
                            xmlDoc.loadXML(data);
                    }
                }
                catch(ee) {
                    Y.log(ee.message + " (Could not parse data " + Y.dump(data) + " to type XML Document)", "warn", "datatype-xml");
                }
            }]]></replacetoken>
			<replacevalue><![CDATA[try {
                if(!LANG.isUndefined(ActiveXObject)) {
                    xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
                    xmlDoc.async = false;
                    xmlDoc.loadXML(data);
                }
            }
            catch(ee) {
                try {
                    if(!LANG.isUndefined(DOMParser)) {
                            xmlDoc = new DOMParser().parseFromString(data, "text/xml");
                    }
                }
                catch(e) {
                }
                    Y.log(ee.message + " (Could not parse data " + Y.dump(data) + " to type XML Document)", "warn", "datatype-xml");
            }]]></replacevalue>
		</replace>

		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/datatype"
				includes="build.xml"
			/>
		</subant>
		<!-- /End Patch for AUI-445 -->

		<!-- Patch for AUI-447 -->
		<replace file="${project.dir}/lib/yui3/src/event/js/event-facade-dom-ie.js">
			<replacetoken><![CDATA[Y.DOMEventFacade = IEEventFacade;]]></replacetoken>
			<replacevalue><![CDATA[var imp = Y.config.doc && Y.config.doc.implementation;

            if (imp && (!imp.hasFeature('Events', '2.0'))) {
                Y.DOMEventFacade = IEEventFacade;
            }]]></replacevalue>
		</replace>

		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/event"
				includes="build-base-ie.xml"
			/>
		</subant>
		<!-- /End Patch for AUI-447 -->

		<!-- Patch for AUI-672 -->
		<replace file="${project.dir}/lib/yui3/src/node/js/node.js">
			<replacetoken><![CDATA[args[0] instanceof Y_Node]]></replacetoken>
			<replacevalue><![CDATA[Y.instanceOf(args[0], Y_Node)]]></replacevalue>
		</replace>

		<replace file="${project.dir}/lib/yui3/src/node/js/node.js">
			<replacetoken><![CDATA[args[1] instanceof Y_Node]]></replacetoken>
			<replacevalue><![CDATA[Y.instanceOf(args[1], Y_Node)]]></replacevalue>
		</replace>

		<replace file="${project.dir}/lib/yui3/src/node/js/node.js">
			<replacetoken><![CDATA[node instanceof Y_Node]]></replacetoken>
			<replacevalue><![CDATA[Y.instanceOf(node, Y_Node)]]></replacevalue>
		</replace>

		<replace file="${project.dir}/lib/yui3/src/node/js/node.js">
			<replacetoken><![CDATA[refNode instanceof Y_Node]]></replacetoken>
			<replacevalue><![CDATA[Y.instanceOf(refNode, Y_Node)]]></replacevalue>
		</replace>

		<replace file="${project.dir}/lib/yui3/src/node/js/node.js">
			<replacetoken><![CDATA[a instanceof Y_Node]]></replacetoken>
			<replacevalue><![CDATA[Y.instanceOf(a, Y_Node)]]></replacevalue>
		</replace>

		<replace file="${project.dir}/lib/yui3/src/node/js/node.js">
			<replacetoken><![CDATA[b instanceof Y_Node]]></replacetoken>
			<replacevalue><![CDATA[Y.instanceOf(b, Y_Node)]]></replacevalue>
		</replace>

		<replace file="${project.dir}/lib/yui3/src/node/js/node.js">
			<replacetoken><![CDATA[nodes instanceof Y.Node]]></replacetoken>
			<replacevalue><![CDATA[Y.instanceOf(nodes, Y.Node)]]></replacevalue>
		</replace>

		<replace file="${project.dir}/lib/yui3/src/node/js/node.js">
			<replacetoken><![CDATA[nodes[0] instanceof Y.Node]]></replacetoken>
			<replacevalue><![CDATA[Y.instanceOf(nodes[0], Y.Node)]]></replacevalue>
		</replace>

		<replace file="${project.dir}/lib/yui3/src/node/js/node-region.js">
			<replacetoken><![CDATA[node2 instanceof Y.Node]]></replacetoken>
			<replacevalue><![CDATA[Y.instanceOf(node2, Y.Node)]]></replacevalue>
		</replace>

		<replace file="${project.dir}/lib/yui3/src/node/js/nodelist.js">
			<replacetoken><![CDATA[nodes instanceof Y.Node]]></replacetoken>
			<replacevalue><![CDATA[Y.instanceOf(nodes, Y.Node)]]></replacevalue>
		</replace>

		<replace file="${project.dir}/lib/yui3/src/node/js/nodelist.js">
			<replacetoken><![CDATA[nodes[0] instanceof Y.Node]]></replacetoken>
			<replacevalue><![CDATA[Y.instanceOf(nodes[0], Y.Node)]]></replacevalue>
		</replace>

		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/node"
				includes="build.node.xml"
			/>
		</subant>

		<replace file="${project.dir}/lib/yui3/src/node/js/node-screen.js">
			<replacetoken><![CDATA[node2 instanceof Y.Node]]></replacetoken>
			<replacevalue><![CDATA[Y.instanceOf(node2, Y.Node)]]></replacevalue>
		</replace>

		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/node"
				includes="build.screen.xml"
			/>
		</subant>

		<replace file="${project.dir}/lib/yui3/src/node-menunav/js/node-menunav.js">
			<replacetoken><![CDATA[Y.message("Pause path");]]></replacetoken>
			<replacevalue><![CDATA[//Y.message("Pause path");]]></replacevalue>
		</replace>

		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/node-menunav"
				includes="build.xml"
			/>
		</subant>
		<!-- /End Patch for AUI-672 -->

		<!-- Patch for AUI-799 -->
		<replace file="${project.dir}/lib/yui3/src/event/js/event-dom.js">
			<replacetoken><![CDATA[v.detachAll();]]></replacetoken>
			<replacevalue><![CDATA[if (v.type == 'unload') {
                    v.fire(e);
                }
                v.detachAll();]]></replacevalue>
		</replace>

		<subant target="all" failonerror="false">
			<property name="lint.skip" value="true"/>
			<fileset
				dir="${project.dir}/lib/yui3/src/event"
				includes="build.xml"
			/>
		</subant>
		<!-- /End Patch for AUI-799 -->
	</target>

	<target name="create-release">
		<echo>Replacing @VERSION@ tokens</echo>

		<replaceregexp match="@VERSION@" replace="${release.version}" flags="g" byline="true">
			<fileset dir="${release.temp.dir}/build/" includes="**/aui-*.js"/>
		</replaceregexp>

		<echo>Creating Zip file ${release.name}.zip</echo>

		<!-- I would just use "git archive" for this, but I couldn't find a decent way to add the version numbers
			to the build files (also git archive will only export a commit, not the current working tree state,
			which is something we use to test a change inside of Liferay) -->

		<exec executable="git" dir="${project.dir}" outputproperty="release.comment" failifexecutionfails="false">
			<arg value="log" />
			<arg value="-1" />
			<arg value="--format=SHA: %h on %cD" />
			<arg value="HEAD" />
		</exec>

		<zip basedir="${release.temp.dir}" comment="${release.comment}" destfile="${project.dir}/${release.file.name}" />

		<delete dir="${release.temp.dir}" />
	</target>

	<target name="release-full" depends="clean-release">
		<copy todir="${release.temp.dir}">
			<fileset dir="${project.dir}">
				<include name="api/**" />
				<include name="build/**" />
				<include name="demos/**" />
				<include name="lib/yui-combo/**" />
				<include name="sandbox/**" />
				<include name="*.txt" />
			</fileset>
		</copy>

		<delete dir="${release.temp.dir}/sandbox/tags" />
		<delete dir="${release.temp.dir}/sandbox/taglibs" />

		<antcall target="create-release" />
	</target>

	<target name="release-minimal" depends="clean-release">
		<copy todir="${release.temp.dir}">
			<fileset dir="${project.dir}">
				<include name="build/**" />
				<include name="demos/**" />
				<include name="*.txt" />
			</fileset>
		</copy>

		<antcall target="create-release" />
	</target>

	<target name="deploy" depends="release">
		<if>
			<isset property="portal.src.directory" />
			<then>
				<copy todir="${portal.src.directory}/portal-web/third-party" overwrite="true">
					<fileset dir="${project.dir}">
						<include name="${release.file.name}"/>
					</fileset>
				</copy>

				<subant target="build-alloy">
					<fileset
						dir="${portal.src.directory}/portal-web"
						includes="build.xml"
					/>
				</subant>
			</then>
			<else>
				<echo>
					Please add the following property to your build.${user.name}.properties file:
					portal.src.directory=/path/to/liferay-portal
				 </echo>
			</else>
		</if>
	</target>

	<target name="version-aui">
		<var name="old.version" value="${release.version}"/>
		<input addProperty="version" message="Enter the new version (currently ${old.version}):"/>
		<echo>Old version: ${old.version}</echo>
		<echo>New version: ${version}</echo>
		<replace file="${project.dir}/build.properties">
			<replacefilter token="release.version=${old.version}" value="release.version=${version}" />
		</replace>

		<if>
			<isset property="portal.src.directory" />
			<then>
				<var name="portal.web.dir" value="${portal.src.directory}/portal-web"/>
				<var name="portal.thirdparty.dir" value="${portal.web.dir}/third-party"/>
				<var name="old.alloy.zip" value="alloy-${old.version}.zip"/>
				<var name="new.alloy.zip" value="alloy-${version}.zip"/>

				<if>
					<available file="${portal.thirdparty.dir}/${old.alloy.zip}" />
					<then>
						<echo>Moving ${portal.thirdparty.dir}/${old.alloy.zip} to ${portal.thirdparty.dir}/${new.alloy.zip}</echo>
						<move file="${portal.thirdparty.dir}/${old.alloy.zip}" tofile="${portal.thirdparty.dir}/${new.alloy.zip}" />
					</then>
				</if>

				<echo>Replacing ${old.alloy.zip} with ${new.alloy.zip} in ${portal.web.dir}/build.xml</echo>
				<replace file="${portal.web.dir}/build.xml">
					<replacetoken expandProperties="true"><![CDATA[<property name="alloy.file" value="${old.alloy.zip}" />]]></replacetoken>
					<replacevalue expandProperties="true"><![CDATA[<property name="alloy.file" value="${new.alloy.zip}" />]]></replacevalue>
				</replace>
			</then>
		</if>
	</target>

	<target name="release" depends="release-minimal,clean-release" />

	<target name="remove-whitespace">
		<echo>Removing trailing spaces of the source files.</echo>

		<replaceregexp match="[\t ]+$" replace="" flags="g" byline="true">
			<fileset dir="${project.dir}/src/" includes="*.js"/>
		</replaceregexp>
	</target>


	<!--
		YUI Docs ant tasks
	-->
	<property name="project.name" value="Alloy UI" />
	<property name="project.url" value="http://alloy.liferay.com/deploy/api" />
	<property name="project.docs.dir" value="${project.dir}/resources/docs" />
	<property name="yui.version" location="3.0.0" />

	<property name="yuidoc.output.dir" location="${project.dir}/_api" />
	<property name="yuidoc.home" location="${project.dir}/lib/yui-yuidoc" />
	<property name="yuidoc.exec" location="${yuidoc.home}/bin/yuidoc.py" />
	<property name="yuidoc.tmpdir" location="${project.docs.dir}/temp" />
	<property name="yuidoc.parsein.dir" location="${project.dir}/build" />
	<property name="yuidoc.template.dir" location="${project.docs.dir}/template" />

	<target name="build-doc" depends="clean-doc">
		<echo>Deleting old API files</echo>
		<delete>
			<fileset dir="${project.dir}/api" includes="**/*" />
		</delete>

		<mkdir dir="${yuidoc.tmpdir}" />
		<mkdir dir="${yuidoc.tmpdir}/parsertmp" />

		<echo>Generating ${project.name} Documentation</echo>
		<var name="yuidoc.modules.list" value=""/>
		<for param="dir">
			<path>
				<dirset
					dir="${project.dir}/build"
					includes="*"
				/>
			</path>
			<sequential>
				<var name="yuidoc.modules.list" value="@{dir} ${yuidoc.modules.list}"/>
			</sequential>
		</for>
		<exec executable="${yuidoc.exec}">
			<arg line="${yuidoc.modules.list}"/>
			<arg value="-p"/>
			<arg value="${yuidoc.tmpdir}/parsertmp"/>
			<arg value="-o" />
			<arg value="${yuidoc.output.dir}" />
			<arg value="-t" />
			<arg value="${yuidoc.template.dir}" />
			<arg value="-m" />
			<arg value="${project.name}" />
			<arg value="-Y" />
			<arg value="${yui.version}" />
			<arg value="-v" />
			<arg value="${release.version}" />
			<arg value="-u" />
			<arg value="${project.url}" />
		</exec>

		<copy todir="${project.dir}/api" overwrite="true">
			<fileset dir="${project.dir}/_api" includes="**/*" />
		</copy>

		<echo>Removing Temp Built Files from ${yuidoc.tmpdir}</echo>
		<delete dir="${yuidoc.tmpdir}" />
		<delete dir="${project.dir}/_api" />
	</target>

	<target name="clean-doc" description="Clean out build">
		<echo>Removing Documentation Built Files</echo>
		<delete dir="${yuidoc.tmpdir}" />
		<delete dir="${project.dir}/_api" />
	</target>
</project>